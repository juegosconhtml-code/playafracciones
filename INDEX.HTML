<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego: Hugo en el Fondo Marino</title>
<style>
/* ESTILOS GENERALES Y RESET */
* { box-sizing: border-box; }

body {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
font-family: 'Courier New', Courier, monospace;
margin: 0; padding: 0;
overflow: hidden;
height: 100vh; width: 100vw;
background-color: #2c3e50;
user-select: none;
}

#gameCanvas {
display: block;
cursor: none;
touch-action: none;
box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
border-radius: 4px;
max-width: 100%; max-height: 100%;
object-fit: contain;
}

/* --- BOT√ìN DE M√öSICA REVISADO --- */
#btnMusic {
position: absolute;
top: 20px; right: 20px;
z-index: 2000;
background-color: rgba(0, 0, 0, 0.8);
color: #e74c3c; /* Rojo por defecto (apagado) */
border: 2px solid #e74c3c;
padding: 10px 15px;
font-family: 'Courier New', Courier, monospace;
font-weight: bold;
font-size: 16px;
cursor: pointer;
border-radius: 8px;
text-transform: uppercase;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
transition: all 0.2s;
}

#btnMusic:hover {
transform: scale(1.1);
}

#btnMusic.active {
color: #2ecc71; /* Verde cuando est√° activo */
border-color: #2ecc71;
box-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
}

/* --- PANTALLAS --- */
.screen {
position: absolute; top: 0; left: 0;
width: 100%; height: 100%;
background: url('https://drive.google.com/thumbnail?id=1OF29IkDrqtxy2pw8WTHjsNhojpRehpnO&sz=w1000') no-repeat center center fixed;
background-size: cover;
display: flex; flex-direction: column;
align-items: center; justify-content: center;
z-index: 10;
}

#selectionScreen, #difficultyScreen {
display: none;
background-color: rgba(0, 0, 0, 0.92);
overflow-y: auto;
padding: 20px 0;
}

/* --- ELEMENTOS PANTALLA INICIO --- */
#logoTitulo {
max-width: 98%; max-height: 70vh;
margin-top: 10px; object-fit: contain;
filter: drop-shadow(0 0 15px rgba(0,0,0,0.8));
}

#btnStart {
padding: 15px 40px;
font-size: 3.5vmin; font-weight: bold;
color: #fff; background-color: #e67e22;
border: 3px solid #fff; border-radius: 50px;
cursor: pointer;
box-shadow: 0 5px 15px rgba(0,0,0,0.5);
transition: transform 0.2s;
z-index: 11; margin-top: 2vh;
font-family: Arial, sans-serif;
}
#btnStart:hover { transform: scale(1.1); background-color: #d35400; }

/* --- ELEMENTOS PANTALLAS DE SELECCI√ìN --- */
h1 {
color: #fff; font-size: 4vmin; margin: 2vh 0;
text-shadow: 0 0 15px #00ffff; text-align: center;
font-family: Arial, sans-serif;
}

.container-flex {
display: flex; flex-wrap: wrap;
justify-content: center; gap: 15px; width: 95%;
}

/* CARDS */
.char-card {
display: flex; flex-direction: column;
align-items: center; cursor: pointer;
transition: transform 0.2s; flex: 0 1 20%;
min-width: 120px; margin-bottom: 1vh;
}
.char-card:hover { transform: scale(1.05); z-index: 100; }

.char-option {
height: 18vh; width: auto; max-width: 100%;
object-fit: contain;
border: 2px solid rgba(255, 255, 255, 0.5);
border-radius: 12px;
background-color: rgba(255, 255, 255, 0.1);
}
.char-card:hover .char-option {
border-color: #00ffff;
background-color: rgba(255, 255, 255, 0.2);
box-shadow: 0 0 15px #00ffff;
}

.char-name {
background-color: #f1c40f; color: #000;
padding: 4px 8px; border-radius: 6px;
font-size: 1.8vmin; font-weight: 900;
text-transform: uppercase; text-align: center;
margin-top: 5px; border: 2px solid #fff;
width: 95%; font-family: Arial, sans-serif;
}
.char-card:hover .char-name { background-color: #00ffff; border-color: #000; }

/* BOTONES DIFICULTAD */
.difficulty-button {
padding: 15px 40px; font-size: 3vmin; font-weight: bold;
color: #fff; border: 3px solid #fff; border-radius: 50px;
cursor: pointer; margin: 10px; min-width: 200px;
text-align: center; font-family: Arial, sans-serif;
transition: transform 0.2s;
}
.difficulty-button:hover { transform: scale(1.1); }
.difficulty-easy { background-color: #27ae60; }
.difficulty-normal { background-color: #f39c12; }
.difficulty-hard { background-color: #e74c3c; }
.difficulty-nightmare { background-color: #8e44ad; }

</style>
</head>
<body>

<button id="btnMusic" onclick="toggleAudio()">üîá M√öSICA: OFF</button>

<div id="startScreen" class="screen">
<img id="logoTitulo" src="https://drive.google.com/thumbnail?id=1RUyg3Z70ipSjsBN01VXvICmJkMWp7JI-&sz=w1000" alt="Logo Hugo">
<button id="btnStart">JUGAR</button>
</div>

<div id="selectionScreen" class="screen">
<h1>¬°ELIGE A TU MATEAMIGO!</h1>
<div class="container-flex">
<div class="char-card" onclick="elegirPersonaje('https://drive.google.com/thumbnail?id=1gEjolJKTX7DCHdZ8nAspew_QHMD9d8oa&sz=w1000')">
<img class="char-option" src="https://drive.google.com/thumbnail?id=1gEjolJKTX7DCHdZ8nAspew_QHMD9d8oa&sz=w1000">
<div class="char-name">SOUHAILA</div>
</div>
<div class="char-card" onclick="elegirPersonaje('https://drive.google.com/thumbnail?id=1aOCNeDjq3DivfhzA8U7kWTd1qP2kO727&sz=w1000')">
<img class="char-option" src="https://drive.google.com/thumbnail?id=1aOCNeDjq3DivfhzA8U7kWTd1qP2kO727&sz=w1000">
<div class="char-name">M√ìNICA</div>
</div>
<div class="char-card" onclick="elegirPersonaje('https://drive.google.com/thumbnail?id=1MT3LAVMZtm-TQnlDM3rxQHh--nAqwosl&sz=w1000')">
<img class="char-option" src="https://drive.google.com/thumbnail?id=1MT3LAVMZtm-TQnlDM3rxQHh--nAqwosl&sz=w1000">
<div class="char-name">IN√âS</div>
</div>
<div class="char-card" onclick="elegirPersonaje('https://drive.google.com/thumbnail?id=1ISYx7zDGHpDoX-FOENxINz0JOvotPe0Z&sz=w1000')">
<img class="char-option" src="https://drive.google.com/thumbnail?id=1ISYx7zDGHpDoX-FOENxINz0JOvotPe0Z&sz=w1000">
<div class="char-name">HUGO</div>
</div>
<div class="char-card" onclick="elegirPersonaje('https://drive.google.com/thumbnail?id=104tnAGdnSyvIWJoDNQZSy9v4QckTNcjz&sz=w1000')">
<img class="char-option" src="https://drive.google.com/thumbnail?id=104tnAGdnSyvIWJoDNQZSy9v4QckTNcjz&sz=w1000">
<div class="char-name">CHEN</div>
</div>
</div>
</div>

<div id="difficultyScreen" class="screen">
<h1>¬°ELIGE LA DIFICULTAD!</h1>
<div class="container-flex">
<button class="difficulty-button difficulty-easy" onclick="elegirDificultad(0.2)">F√ÅCIL</button>
<button class="difficulty-button difficulty-normal" onclick="elegirDificultad(0.4)">NORMAL</button>
<button class="difficulty-button difficulty-hard" onclick="elegirDificultad(0.7)">DIF√çCIL</button>
<button class="difficulty-button difficulty-nightmare" onclick="elegirDificultad(1.0)">PESADILLA</button>
</div>
</div>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
// ==========================================
// SISTEMA DE AUDIO INTEGRADO Y MODIFICADO
// ==========================================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let isPlaying = false; // Controla la m√∫sica PIRATA
let nextNoteTime = 0;
let noteIndex = 0;
let timerID;

// Variable para el sonido de burbujas
let bubbleSource = null;
let bubbleGain = null;

const btnMusicJS = document.getElementById('btnMusic');

// Notas musicales (Frecuencias)
const N = {
c3: 130.81, d3: 146.83, e3: 164.81, f3: 174.61, g3: 196.00, a3: 220.00, b3: 246.94,
c4: 261.63, d4: 293.66, e4: 329.63, f4: 349.23, g4: 392.00, a4: 440.00, bb4: 466.16, b4: 493.88,
c5: 523.25, d5: 587.33, e5: 659.25, f5: 698.46
};

// Melod√≠a Pirata (Matriz: [nota, duraci√≥n_negra, nota_bajo])
const cancionPirata = [
[N.d4, 1.5, N.d3], [N.a4, 0.5, null], [N.f4, 0.5, N.a3], [N.d4, 0.5, null],
[N.e4, 1.5, N.c3], [N.c4, 0.5, null], [N.e4, 0.5, N.g3], [N.g4, 0.5, null],
[N.f4, 1.5, N.d3], [N.d4, 0.5, null], [N.f4, 0.5, N.a3], [N.a4, 0.5, null],
[N.g4, 1.0, N.g3], [N.f4, 0.5, null], [N.e4, 1.5, N.c3],
[N.d4, 1.5, N.d3], [N.a4, 0.5, null], [N.d5, 0.5, N.f3], [N.a4, 0.5, null],
[N.c5, 1.5, N.c3], [N.g4, 0.5, null], [N.e4, 0.5, N.e3], [N.c4, 0.5, null],
[N.d4, 2.0, N.d3], [N.f4, 0.5, null], [N.e4, 0.5, N.a3],
[N.d4, 3.0, N.d3]
];

const tempo = 220; 
const secondsPerBeat = 60.0 / tempo;

function playTone(freq, type, duration, vol, time) {
if (!freq) return;
const osc = audioCtx.createOscillator();
const gain = audioCtx.createGain();
osc.type = type; 
osc.frequency.value = freq;
osc.connect(gain);
gain.connect(audioCtx.destination);
osc.start(time);
gain.gain.setValueAtTime(0, time);
gain.gain.linearRampToValueAtTime(vol, time + 0.05); 
gain.gain.exponentialRampToValueAtTime(0.01, time + duration - 0.05); 
osc.stop(time + duration);
}

function scheduler() {
while (nextNoteTime < audioCtx.currentTime + 0.1) {
const notaActual = cancionPirata[noteIndex];
const freqMelodia = notaActual[0];
const duracion = notaActual[1] * secondsPerBeat; 
const freqBajo = notaActual[2];
if (freqMelodia) playTone(freqMelodia, 'square', duracion, 0.15, nextNoteTime);
if (freqBajo) playTone(freqBajo, 'sawtooth', duracion, 0.15, nextNoteTime);
nextNoteTime += duracion;
noteIndex++;
if (noteIndex === cancionPirata.length) {
noteIndex = 0;
}
}
timerID = requestAnimationFrame(scheduler);
}

// --- FUNCI√ìN NUEVA: SONIDO DE BURBUJAS ---
function playBubbles() {
    if (bubbleSource) return; // Si ya suena, no hacer nada
    
    // Crear ruido blanco (burbujeo)
    const bufferSize = audioCtx.sampleRate * 2; 
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
    }

    bubbleSource = audioCtx.createBufferSource();
    bubbleSource.buffer = buffer;
    bubbleSource.loop = true;

    // Filtro paso bajo para que suene "bajo el agua"
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 400; 

    // A√±adir modulaci√≥n para que el sonido ondule
    const lfo = audioCtx.createOscillator();
    lfo.type = 'sine';
    lfo.frequency.value = 0.5; // Ola lenta
    const lfoGain = audioCtx.createGain();
    lfoGain.gain.value = 200; 
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);
    lfo.start();

    bubbleGain = audioCtx.createGain();
    bubbleGain.gain.value = 0.25; // Volumen suave

    bubbleSource.connect(filter);
    filter.connect(bubbleGain);
    bubbleGain.connect(audioCtx.destination);
    bubbleSource.start();
}

function stopBubbles() {
    if (bubbleSource) {
        bubbleSource.stop();
        bubbleSource = null;
    }
}

// --- MODIFICACI√ìN: TOGGLE AUDIO AHORA DISCRIMINA ESTADO DEL JUEGO ---
function toggleAudio() {
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }

    if (juegoIniciado) {
        // --- MODO JUEGO: CONTROLAR BURBUJAS ---
        if (!bubbleSource) {
            playBubbles();
            btnMusicJS.innerHTML = "üéµ SONIDO: ON";
            btnMusicJS.classList.add("active");
        } else {
            stopBubbles();
            btnMusicJS.innerHTML = "üîá SONIDO: OFF";
            btnMusicJS.classList.remove("active");
        }
    } else {
        // --- MODO MEN√ö: CONTROLAR M√öSICA PIRATA ---
        if (!isPlaying) {
            isPlaying = true;
            noteIndex = 0;
            nextNoteTime = audioCtx.currentTime + 0.1;
            scheduler();
            btnMusicJS.innerHTML = "üéµ M√öSICA: ON";
            btnMusicJS.classList.add("active");
        } else {
            isPlaying = false;
            cancelAnimationFrame(timerID);
            btnMusicJS.innerHTML = "üîá M√öSICA: OFF";
            btnMusicJS.classList.remove("active");
        }
    }
}

// ==========================================
// C√ìDIGO DEL JUEGO
// ==========================================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const startScreenJS = document.getElementById('startScreen');
const selectionScreenJS = document.getElementById('selectionScreen');
const difficultyScreenJS = document.getElementById('difficultyScreen');
const btnStartJS = document.getElementById('btnStart');

let score = 0;
let gameOver = false;
let enemigosActivos = false;
let juegoIniciado = false;

// Variables globales
let personajeElegidoSrc = "";
let factorVelocidadEnemigos = 0.4;

// 0. FONDO
const imagenFondo = new Image();
imagenFondo.src = "https://drive.google.com/thumbnail?id=1OF29IkDrqtxy2pw8WTHjsNhojpRehpnO&sz=w1000";

// 1. JUGADOR
const jugador = { x: 300, y: 20, ancho: 180, alto: 180 };
const imagenJugador = new Image();

// 2. OBJETIVOS
const coleccionCompleta = [
{ id: '1-CeK-X5YTUeXwQUwqBoIDnIJb1H47Bx0', nombre: 'UN CUARTO' },
{ id: '1j2ZSo3PbqBZkEaWJuz7GcOaP5UD-iVyj', nombre: 'UN SEXTO' },
{ id: '1OLiEr85Mjh7rT-xUHayH3HrtJC0fEClV', nombre: 'UN QUINTO' },
{ id: '17GslOH4qzD2ZvMrhVVvt-BjnK0n_lSHU', nombre: 'UN SEPTIMO' },
{ id: '1632mZTFXKkniweuAw897zryli3TaXoRy', nombre: 'UN TERCIO' },
{ id: '1p-EoljAyBUlvIHAn1Zc_OfH-dbJNTDet', nombre: 'UN MEDIO' },
{ id: '1kmAecMBvSlJK3BKWyV8exJOQlZRz7PZA', nombre: 'UN DECIMO' },
{ id: '1jJMZBJkp0n-Y6PcNu7vADjolxxh_k340', nombre: 'UN ENTERO' },
{ id: '1wsoWz5ow19Kv9A7z0wiAQ9shc7BJE6jW', nombre: 'TRES TERCIO' },
{ id: '1sI-30WVU7bwwwN_S0eEFs3fSdGhc1Ax9', nombre: 'UN OCTAVO' },
{ id: '1rgcFN5OJDs-dHUY5x1v5RCfoND4gqj-W', nombre: 'UN NOVENO' },
{ id: '10Y7lYDu1um34_1irxEtSR-L7wT_LK0a1', nombre: 'DOS DECIMOS' },
{ id: '1-iqkFk9nLqPemgfGNTayp9avjvgg-Ea2', nombre: 'CINCO OCTAVOS' },
{ id: '1ydMPN6hhdSUdcLWWqXhmg6y2gD2W7KOX', nombre: 'TRES SEXTOS' },
{ id: '16B6UxRbaQxqvPBZuCLjR8dQTKXXfUxWh', nombre: 'NUEVE DECIMOS' },
{ id: '12y_WKu-2X8W990zlX6r_zDgExGKKHH7k', nombre: 'DOS QUINTOS' },
{ id: '12V1B6HCP0ac6R2YMGxqLjhGIaLhNf5O1', nombre: 'CERO NOVENOS' },
{ id: '17zn2pxCzEDAwJCUL_USB7VXP9NpTT0NR', nombre: 'DOS SEPTIMOS' },
{ id: '16ZfPpeuICxOPBSzwshcjNUuYyPsyl8Ys', nombre: 'CINCO SEPTIMOS' },
{ id: '16QMkEObSBQBi96GaXQYmtdSNC6idKvmD', nombre: 'OCHO OCTAVOS' },
{ id: '1E1BigOMfqUbM6X4suv3r0Mfxs6u2xjIl', nombre: 'CERO QUINTOS' },
{ id: '1AnUt5VKIPIwsAaQobcGn_RYr7WCHlqC8', nombre: 'CERO TERCIOS' },
{ id: '1ABoFE0cuvkUvNbJYpvxGHbVPzJNZh8jQ', nombre: 'CERO SEXTOS' },
{ id: '1IVieQK2Yz4fqaQSH_4kFkea7GZzRYtKB', nombre: 'DOS OCTAVOS' },
{ id: '1GU-0xxuLA6xxIwJGmKLCwqDuwzoFX1Jy', nombre: 'SIETE NOVENOS' },
{ id: '1FPCrYug4-uHOc9cl7wcmRGzVc3wOO3zl', nombre: 'TRES QUINTOS' },
{ id: '1Kq2j2KJ5IawRKlQJ1coPTcEy56m_b6c6', nombre: 'OCHO NOVENOS' },
{ id: '1KSRZPLZfTKdzly42hJkr9nOe0wElkf6U', nombre: 'CUATRO SEXTOS' },
{ id: '1JhE1nwSFDTTr8HlsWGgCzmboAZeWw2KZ', nombre: 'CERO CUARTOS' },
{ id: '1TtZv7YhZOJytQcux3U3GDTkmnANl9JiP', nombre: 'OCHO DECIMOS' },
{ id: '1SlEkjppX7udGX8xMHNbKytcmxQ7WmyKX', nombre: 'SEIS OCTAVOS' },
{ id: '1RbPhcc4KN2Qxtz8JqcwhoDY5YMb09vJ6', nombre: 'CUATRO OCTAVOS' },
{ id: '1YvxblV72tdAGe0pI0bM327G500S3Uwl4', nombre: 'TRES SEPTIMOS' },
{ id: '1Ytx6JmMqMS77nKg_lHw2ZdZK3n7wiy0i', nombre: 'DIEZ DECIMOS' },
{ id: '1V9QNLtb85dzBzYigf80ef_MHXQmbzWAQ', nombre: 'DOS SEXTOS' },
{ id: '1eEChu7IypQ6jAf10PcIjoApK1mHnTIi_', nombre: 'SIETE SEPTIMOS' },
{ id: '1dKa0BpTFfsD5AgCPTNhtTeUsTs3qSsLR', nombre: 'SEIS NOVENOS' },
{ id: '1bGATQrYzaTOexWo3Q1PyZDrZuAeWw326', nombre: 'NUEVE NOVENOS' },
{ id: '1fq8smv5iDMyRU4RX7gBD-maWznU1eoHS', nombre: 'SEIS SEPTIMOS' },
{ id: '1fU77DGKMSwS26JAGN8fye_W-rZUkBxxE', nombre: 'SEIS SEXTOS' },
{ id: '1eqVUgHqobfv5T-2hmWBx3Tb0ILgiZrkJ', nombre: 'SIETE OCTAVOS' },
{ id: '1hTvBBRkTF8ykAlifIvKakpPDsSBr0PP1', nombre: 'CUATRO SEPTIMOS' },
{ id: '1gtQb9appBhKQQxLpMKNxzr0J0SXrS6N8', nombre: 'CUATRO QUINTOS' },
{ id: '1gY119c_-FH-MgZDO8SLQEfPbTgC2RIoU', nombre: 'CUATRO NOVENOS' },
{ id: '1i81FEPsc5KNy_JEwrHbdV-J-of6Jixws', nombre: 'CINCO DECIMOS' },
{ id: '1hs3Bmqyq0bpPqFnDTEhVdWXj2G_tR0oT', nombre: 'TRES NOVENOS' },
{ id: '1hnIZJ4stcHEiFRB6BHYBHjbFIHiv6Rq8', nombre: 'CERO DECIMOS' },
{ id: '1lajJ8OapzIW3EjYaSOi4r09s41xsmNSb', nombre: 'CUATRO CUARTOS' },
{ id: '1ir9XWQlUOyDYGMxh3VlMLEJLelCUysvp', nombre: 'CINCO SEXTOS' },
{ id: '1iIBPX_m6f_YONZdKtOoMOQ5ukRuA-5ur', nombre: 'TRES DECIMOS' },
{ id: '1oDXLEo49aIgmdMMX9arO8zTFd1SXyUDS', nombre: 'DOS MEDIOS' },
{ id: '1o5PiYxhNQCWJuG8007OYkXlBZcyhvBq6', nombre: 'CINCO QUINTOS' },
{ id: '1mzDRe7MUswAAqNmmYsEBBGvt6B5Q41Tq', nombre: 'DOS CUARTOS' },
{ id: '1qcJR6Xk3CQGUIUvGLaKT1Yf6hKAIu9Kk', nombre: 'DOS TERCIOS' },
{ id: '1qUvzyxSFpvE8E2WbCCECEmo9pCGvi0lQ', nombre: 'TRES CUARTOS' },
{ id: '1oI9CSJhiUgDm7c1tM87Asi_4_2P9H9uI', nombre: 'CINCO NOVENOS' },
{ id: '1uddzom14-lXPBd7VNLySt54MO9qCzH-H', nombre: 'CUATRO DECIMOS' },
{ id: '1tiQ6R7OiDB3iuBJQzpfzyrtKpvthE9_R', nombre: 'CERO MEDIOS' },
{ id: '1rLYfgAD1Z5JaD4ghq5pBpFbrYuH6A4Kz', nombre: 'SIETE DECIMOS' },
{ id: '1yIGDWg0tfNBBhw30WquL7ngMWDhJ7bvM', nombre: 'TRES OCTAVOS' },
{ id: '1wd4rAkKkVDWdAMD6ILUtPmn6V2W4TU2L', nombre: 'CERO SEPTIMOS' },
{ id: '1w4ZxgJyLmJw4zBruKEqisKP1gTiN_0_A', nombre: 'CERO OCTAVOS' },
{ id: '1zQfui4BlOwBWZI6c-7X4MzTAtVQlbl-O', nombre: 'SEIS DECIMOS' },
{ id: '1ypvTnZvICoYJEhS18e0BAZ-oA1qLdG6p', nombre: 'DOS NOVENOS' }
];

// Objetos gen√©ricos
const objetivo1 = { x: 0, y: 0, ancho: 160, alto: 160, nombre: '' };
const imgObjetivo1 = new Image();

const objetivo2 = { x: 0, y: 0, ancho: 160, alto: 160, nombre: '' };
const imgObjetivo2 = new Image();

let objetivoActualTexto = "";

// 3. ENEMIGOS
const enemigos = [];
const configVillanos = [
{ id: '1s_S84W-Drk5GIIjnkZ7Ij91ZN6z-0DCy' },
{ id: '13MeTQ0l9-g3avSYLopOEE9b9C3a4Q4e2' },
{ id: '1IGOaXUgmkfqUaPJ_4AofaoUCrIdloLKJ' }
];

function inicializarEnemigos() {
enemigos.length = 0;
configVillanos.forEach(config => {
const img = new Image();
img.src = `https://drive.google.com/thumbnail?id=${config.id}&sz=w1000`;
let potenciaBase = (Math.random() * 6 + 6);
let dirX = Math.random() < 0.5 ? 1 : -1;
let dirY = Math.random() < 0.5 ? 1 : -1;

let zonaSeguraY = canvas.height / 2;
let espacioDisponible = canvas.height - zonaSeguraY - 180;
if (espacioDisponible < 0) espacioDisponible = 0;
let spawnY = zonaSeguraY + (Math.random() * espacioDisponible);

enemigos.push({
x: Math.random() * (canvas.width - 180),
y: spawnY,
ancho: 180, alto: 180, imagen: img,
velocidadX: potenciaBase * factorVelocidadEnemigos * dirX,
velocidadY: potenciaBase * factorVelocidadEnemigos * dirY
});
});
}

// CONTROLES
function moverJugador(clientX, clientY) {
const rect = canvas.getBoundingClientRect();
const scaleX = canvas.width / rect.width;
const scaleY = canvas.height / rect.height;
let mouseX = (clientX - rect.left) * scaleX;
let mouseY = (clientY - rect.top) * scaleY;

jugador.x = mouseX - (jugador.ancho / 2);
jugador.y = mouseY - (jugador.alto / 2);

if (jugador.x < 0) jugador.x = 0;
if (jugador.x > canvas.width - jugador.ancho) jugador.x = canvas.width - jugador.ancho;
if (jugador.y < 0) jugador.y = 0;
if (jugador.y > canvas.height - jugador.alto) jugador.y = canvas.height - jugador.alto;
}

canvas.addEventListener('mousemove', (e) => { if (juegoIniciado && !gameOver) moverJugador(e.clientX, e.clientY); });
canvas.addEventListener('touchmove', (e) => {
e.preventDefault();
if (juegoIniciado && !gameOver) moverJugador(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });
canvas.addEventListener('touchstart', (e) => {
e.preventDefault();
if (juegoIniciado && !gameOver) moverJugador(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });

// L√ìGICA
function detectarColision(rect1, rect2, padding) {
return (rect1.x + padding < rect2.x + rect2.ancho - padding &&
rect1.x + rect1.ancho - padding > rect2.x + padding &&
rect1.y + padding < rect2.y + rect2.alto - padding &&
rect1.y + rect1.alto - padding > rect2.y + padding);
}

function moverEnemigos() {
if (!enemigosActivos) return;
enemigos.forEach(enemigo => {
enemigo.x += enemigo.velocidadX;
enemigo.y += enemigo.velocidadY;
if (enemigo.x <= 0 || enemigo.x + enemigo.ancho >= canvas.width) enemigo.velocidadX *= -1;
if (enemigo.y <= 0 || enemigo.y + enemigo.alto >= canvas.height) enemigo.velocidadY *= -1;
});
}

function randomRange(min, max) { return Math.random() * (max - min) + min; }

function reubicarObjetivos() {
let idx1 = Math.floor(Math.random() * coleccionCompleta.length);
let idx2 = Math.floor(Math.random() * coleccionCompleta.length);
while (idx1 === idx2) {
idx2 = Math.floor(Math.random() * coleccionCompleta.length);
}

const item1 = coleccionCompleta[idx1];
const item2 = coleccionCompleta[idx2];

objetivo1.nombre = item1.nombre;
imgObjetivo1.src = `https://drive.google.com/thumbnail?id=${item1.id}&sz=w1000`;

objetivo2.nombre = item2.nombre;
imgObjetivo2.src = `https://drive.google.com/thumbnail?id=${item2.id}&sz=w1000`;

const margin = 30;
const w = objetivo1.ancho;
const h = objetivo1.alto;
const centerX = canvas.width / 2;
const centerY = canvas.height / 2;

let posA, posB;
let splitVertical = Math.random() < 0.5;

if (splitVertical) {
posA = {
x: randomRange(0, centerX - w - margin),
y: randomRange(0, canvas.height - h)
};
posB = {
x: randomRange(centerX + margin, canvas.width - w),
y: randomRange(0, canvas.height - h)
};
} else {
posA = {
x: randomRange(0, canvas.width - w),
y: randomRange(0, centerY - h - margin)
};
posB = {
x: randomRange(0, canvas.width - w),
y: randomRange(centerY + margin, canvas.height - h)
};
}

if (Math.random() < 0.5) {
objetivo1.x = posA.x; objetivo1.y = posA.y;
objetivo2.x = posB.x; objetivo2.y = posB.y;
} else {
objetivo1.x = posB.x; objetivo1.y = posB.y;
objetivo2.x = posA.x; objetivo2.y = posA.y;
}

objetivoActualTexto = Math.random() < 0.5 ? item1.nombre : item2.nombre;
}

function actualizar() {
if (gameOver) return;
moverEnemigos();

if (detectarColision(jugador, objetivo1, 50)) {
if (objetivoActualTexto === objetivo1.nombre) {
score++; 
} else {
score--; 
}
reubicarObjetivos();
}

if (detectarColision(jugador, objetivo2, 50)) {
if (objetivoActualTexto === objetivo2.nombre) {
score++; 
} else {
score--; 
}
reubicarObjetivos();
}

enemigos.forEach(enemigo => {
if (detectarColision(jugador, enemigo, 50)) finDelJuego();
});
}

function dibujarMarcador() {
const w = 220; const h = 50; const x = (canvas.width - w) / 2; const y = 50;
ctx.save();
ctx.fillStyle = 'rgba(0, 40, 80, 0.85)';
ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 2;
ctx.beginPath();
if (ctx.roundRect) ctx.roundRect(x, y, w, h, 15); else ctx.rect(x, y, w, h);
ctx.fill(); ctx.stroke();
ctx.fillStyle = '#fff'; ctx.font = 'bold 24px Arial';
ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
ctx.shadowColor = "#00ffff"; ctx.shadowBlur = 5;
ctx.fillText(`PUNTOS: ${score}`, x + w / 2, y + h / 2 + 2);
ctx.restore();

ctx.save();
ctx.fillStyle = '#ffff00'; 
ctx.font = 'bold 24px Arial';
ctx.textAlign = 'center';
ctx.shadowColor = "#fff"; ctx.shadowBlur = 4;
ctx.fillText(`¬°RECOGE: ${objetivoActualTexto}!`, canvas.width / 2, y + h + 35);
ctx.restore();
}

function dibujar() {
if (imagenFondo.complete && imagenFondo.naturalHeight !== 0) ctx.drawImage(imagenFondo, 0, 0, canvas.width, canvas.height);
else { ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; ctx.fillRect(0, 0, canvas.width, canvas.height);

if (imagenJugador.complete && imagenJugador.naturalHeight !== 0) ctx.drawImage(imagenJugador, jugador.x, jugador.y, jugador.ancho, jugador.alto);

if (imgObjetivo1.complete) {
ctx.drawImage(imgObjetivo1, objetivo1.x, objetivo1.y, objetivo1.ancho, objetivo1.alto);
}
if (imgObjetivo2.complete) {
ctx.drawImage(imgObjetivo2, objetivo2.x, objetivo2.y, objetivo2.ancho, objetivo2.alto);
}

enemigos.forEach(enemigo => {
if (enemigo.imagen.complete && enemigo.imagen.naturalHeight !== 0) ctx.drawImage(enemigo.imagen, enemigo.x, enemigo.y, enemigo.ancho, enemigo.alto);
else { ctx.fillStyle = '#e74c3c'; ctx.fillRect(enemigo.x, enemigo.y, enemigo.ancho, enemigo.alto); }
});

dibujarMarcador();

if (!enemigosActivos && !gameOver) {
ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
ctx.fillRect(0, canvas.height / 2 - 40, canvas.width, 80);
ctx.fillStyle = '#fff'; ctx.font = '30px Arial'; ctx.textAlign = 'center';
ctx.fillText("¬°PREP√ÅRATE! LOS ENEMIGOS LLEGAN...", canvas.width/2, canvas.height/2 + 10);
ctx.textAlign = 'start';
}

if (gameOver) {
ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = 'white'; ctx.font = '50px Arial'; ctx.textAlign = 'center';
ctx.fillText("¬°TE ATRAPARON!", canvas.width/2, canvas.height/2);
ctx.font = '20px Arial';
ctx.fillText("Puntuaci√≥n final: " + score, canvas.width/2, canvas.height/2 + 50);
ctx.fillText("Recarga la p√°gina para intentarlo de nuevo", canvas.width/2, canvas.height/2 + 90);
ctx.textAlign = 'start';
}
}

function finDelJuego() {
gameOver = true;
canvas.style.cursor = 'default';
// Detener sonido burbujas al morir
stopBubbles();
}

function bucleDelJuego() {
actualizar();
dibujar();
requestAnimationFrame(bucleDelJuego);
}

// --- FLUJO DE PANTALLAS ---
btnStartJS.addEventListener('click', () => {
startScreenJS.style.display = 'none';
selectionScreenJS.style.display = 'flex';
});

window.elegirPersonaje = function(srcImagen) {
personajeElegidoSrc = srcImagen;
imagenJugador.src = personajeElegidoSrc;
selectionScreenJS.style.display = 'none';
difficultyScreenJS.style.display = 'flex';
}

window.elegirDificultad = function(factor) {
factorVelocidadEnemigos = factor;
difficultyScreenJS.style.display = 'none';

// Nota: Quitamos la llamada a toggleAudio() de aqu√≠, 
// ya que iniciarJuegoReal gestionar√° el sonido.
if (audioCtx.state === 'suspended') audioCtx.resume();
iniciarJuegoReal();
}

// --- MODIFICACI√ìN IMPORTANTE AQU√ç ---
function iniciarJuegoReal() {
    juegoIniciado = true;
    
    // 1. Si la m√∫sica pirata estaba sonando, la paramos
    if (isPlaying) {
        isPlaying = false;
        cancelAnimationFrame(timerID);
    }
    
    // 2. Iniciamos el sonido de burbujas
    playBubbles();
    btnMusicJS.innerHTML = "üéµ SONIDO: ON";
    btnMusicJS.classList.add("active");

    inicializarEnemigos();
    reubicarObjetivos();
    setTimeout(() => { enemigosActivos = true; }, 3000);
    bucleDelJuego();
}

// Polyfill
if (!CanvasRenderingContext2D.prototype.roundRect) {
CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
if (w < 2 * r) r = w / 2;
if (h < 2 * r) r = h / 2;
this.beginPath(); this.moveTo(x + r, y);
this.arcTo(x + w, y, x + w, y + h, r);
this.arcTo(x + w, y + h, x, y + h, r);
this.arcTo(x, y + h, x, y, r);
this.arcTo(x, y, x + w, y, r);
this.closePath(); return this;
};
}
</script>
</body>
</html>